services:
  # ============================
  # Base de données MySQL
  # ============================
  mysql:
    image: mysql:8.4
    container_name: agrismart_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:?MYSQL_ROOT_PASSWORD requis}
      MYSQL_DATABASE: agrismart_ci
      MYSQL_USER: agrismart
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:?MYSQL_PASSWORD requis}
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --pid-file=/var/lib/mysql-files/mysqld.pid
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - agrismart_network

  # ============================
  # PhpMyAdmin
  # ============================
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: agrismart_phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: agrismart
      PMA_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "8080:80"
    depends_on:
      - mysql
    networks:
      - agrismart_network

  # ============================
  # Cache Redis
  # ============================
  redis:
    image: redis:7.4-alpine
    container_name: agrismart_redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD requis}
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - agrismart_network

  # ============================
  # InfluxDB (pour IoT)
  # ============================
  influxdb:
    image: influxdb:2.7-alpine
    container_name: agrismart_influxdb
    restart: unless-stopped
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUXDB_USER:-agrismart}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUXDB_PASSWORD:?INFLUXDB_PASSWORD requis}
      DOCKER_INFLUXDB_INIT_ORG: agrismart
      DOCKER_INFLUXDB_INIT_BUCKET: sensors
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUXDB_TOKEN:?INFLUXDB_TOKEN requis}
    volumes:
      - influxdb_data:/var/lib/influxdb2
    ports:
      - "${INFLUXDB_PORT:-8086}:8086"
    healthcheck:
      test: [ "CMD", "influx", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - agrismart_network

  # ============================
  # Mosquitto MQTT Broker
  # ============================
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: agrismart_mosquitto
    restart: unless-stopped
    volumes:
      - ./iot_service/config/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mosquitto_data:/mosquitto/data
      - mosquitto_logs:/mosquitto/log
    ports:
      - "1883:1883"
      - "9001:9001"
    networks:
      - agrismart_network

  # ============================
  # Backend API (Node.js)
  # ============================
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: agrismart_api
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Environnement
      NODE_ENV: development
      PORT: 3000

      # Base de données MySQL
      DATABASE_URL: mysql://agrismart:${MYSQL_PASSWORD}@mysql:3306/agrismart_ci
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: agrismart_ci
      DB_USER: agrismart
      DB_PASSWORD: ${MYSQL_PASSWORD}

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}

      # JWT
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET requis}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:?JWT_REFRESH_SECRET requis}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-30d}
      CORS_ORIGIN: http://localhost:3001,http://localhost:3000

      # Services internes
      AI_SERVICE_URL: http://ai_service:5001
      IOT_SERVICE_URL: http://iot_service:4000
    ports:
      - "3000:3000"
    volumes:
      - ./backend:/app
      - /app/node_modules
      - uploads_data:/app/uploads
    healthcheck:
      test: [ "CMD", "wget", "-q", "-O", "-", "http://localhost:3000/api/v1/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - agrismart_network

  # ============================
  # AI Service (Flask/TensorFlow)
  # ============================
  ai_service:
    build:
      context: ./ai_service
      dockerfile: Dockerfile
    container_name: agrismart_ai
    restart: unless-stopped
    environment:
      FLASK_ENV: ${NODE_ENV:-production}
      PORT: 5001
      MODEL_PATH: /app/models
      USE_GPU: ${USE_GPU:-false}
    ports:
      - "5001:5001"
    volumes:
      - ai_models:/app/models
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5001/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - agrismart_network

  # ============================
  # IoT Service (Node.js/MQTT)
  # ============================
  iot_service:
    build:
      context: ./iot_service
      dockerfile: Dockerfile
    container_name: agrismart_iot
    restart: unless-stopped
    depends_on:
      - influxdb
      - mosquitto
      - redis
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 4000

      # MQTT
      MQTT_BROKER_URL: mqtt://mosquitto:1883
      MQTT_USERNAME: ${MQTT_USERNAME:-agrismart}
      MQTT_PASSWORD: ${MQTT_PASSWORD:?MQTT_PASSWORD requis}

      # InfluxDB
      INFLUXDB_URL: http://influxdb:8086
      INFLUXDB_TOKEN: ${INFLUXDB_TOKEN}
      INFLUXDB_ORG: agrismart
      INFLUXDB_BUCKET: sensors

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}

      # Backend API
      BACKEND_API_URL: http://api:3000/api
    ports:
      - "4000:4000"
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:4000/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - agrismart_network

  # ============================
  # Frontend (Next.js)
  # ============================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://localhost:3000/api/v1
        NEXT_PUBLIC_SOCKET_URL: http://localhost:3000
        NEXT_PUBLIC_AI_SERVICE_URL: http://localhost:5001
    container_name: agrismart_frontend
    restart: unless-stopped
    depends_on:
      - api
    environment:
      NODE_ENV: production
    ports:
      - "3001:3000"
    networks:
      - agrismart_network


  # ============================
  # Nginx Reverse Proxy (Production)
  # ============================
  nginx:
    image: nginx:alpine
    container_name: agrismart_nginx
    restart: unless-stopped
    depends_on:
      - api
      - frontend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - agrismart_network

# ============================
# Networks
# ============================
networks:
  agrismart_network:
    driver: bridge

# ============================
# Volumes
# ============================
volumes:
  mysql_data:
    name: agrismart_mysql_data
    driver: local
  redis_data:
    name: agrismart_redis_data
    driver: local
  influxdb_data:
    name: agrismart_influxdb_data
    driver: local
  mosquitto_data:
    name: agrismart_mosquitto_data
    driver: local
  mosquitto_logs:
    name: agrismart_mosquitto_logs
    driver: local
  ai_models:
    name: agrismart_ai_models
  uploads_data:
    name: agrismart_uploads
    driver: local
  frontend_node_modules:
    name: agrismart_frontend_node_modules
